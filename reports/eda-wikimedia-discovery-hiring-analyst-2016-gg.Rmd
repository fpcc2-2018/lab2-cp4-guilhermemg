---
title: "Wikimedia-Discovery-Hiring-Analyst-2016"
author: "Guilherme Gadelha"
date: "April 24, 2018"
output: html_document
---

## Setup

```{r setup, include=FALSE}

library(tidyverse)
library(lubridate)
library(here)
theme_set(theme_bw())

searches = read_csv(here::here("data/search_data.csv"))

head(searches)
names(searches)

```

To make this analysis we modified the original script that gets the data from wikimedia. The modifications are the following:

1. Original data slice size: 100000 observations (logged events)
2. Change of variable name from search_index to num_searches
3. Change of variable name from session_start_timestamp to first_event_timestamp
4. Change of variable name from session_start_date to first_event_date_time

The changes were made for improve the clarity and fidelity to the original dataset.

## Question 1
### What is our daily overall clickthrough rate? How does it vary between the groups?

### Clean Data

Cleaning data, filter distinct sessions by *session_id*. We are interested only on unique sessions, once we want to calculate the daily overrall clickthrough rate.

```{r clean_1}
sessions <- searches %>%
  distinct(session_id, .keep_all = TRUE) %>% 
  mutate(day = round_date(first_event_date_time, unit="day"))
```

We create another variable called *sessions* to record our dataset. This new dataset contains unique sessions (search sessions) and the *day* that each search event occurred.


```{r question_1}

sessions %>% 
  ggplot(aes(x = day, y = num_clicks, fill = group)) +
  geom_col() +
  labs(x = "Day",
       y = "Number of Clicks",
       fill = "Group") +
  facet_grid(~ group)

```

Grouping and counting distinct sessions by *day* and *group*.
```{r}

sessions %>% 
  group_by(day, group) %>% 
  summarise(n_distinct_sessions = n()) %>% 
  head()
```

Grouping and counting search sessions with clicks and with no clicks by *day* and *group*.
```{r}
sessions %>%
  group_by(day, group) %>%  
  summarise(no_click_session = sum(num_clicks == 0),
            with_click_sessions = sum(num_clicks > 0),
            total_distinct_sessions = n(),
            amount_of_clicks = sum(num_clicks)) %>% 
  head()

```

Calculating and plotting the daily clickthrough rate (DCR)
```{r}
dcr_df <- sessions %>%
  group_by(day, group) %>%  
  summarise(no_click_session = sum(num_clicks == 0),
            with_click_sessions = sum(num_clicks > 0),
            total_distinct_sessions = n(),
            amount_of_clicks = sum(num_clicks),
            dcr = with_click_sessions/total_distinct_sessions)

dcr_df

dcr_df %>% 
  ggplot(aes(x = day, y = dcr, color=group)) +
  geom_point() +
  geom_line() +
  geom_hline(aes(yintercept = mean(dcr_df$dcr), linetype="Mean"), colour="red") +
  facet_grid(~ group) +
  labs(x = "Day",
       y = "Clickthrough Rate",
       color="Group",
       linetype="Line Type")
```

The daily overrall clickthrough rate (DCR): _*the proportion of search sessions where the user clicked on one of the results displayed*_. 

For the group *a*, on the first four days the DCR is greather than or equal 0.40, that means around 40% of search sessions resulted in at least one click by the user with the intention of visiting a page listed on a SERP (search engine result page) returned to him after a search query.

It is important to make an observation: a good search engine returns to the user the best result in the firsts positions in the SERP, so he needs to click only once in the page and trigger an action of _visitPage_, logged by the wikimedia servers. In the following days, the clickthrough rate decreases, but stay around 0.40.

For the group *b*, the clickthrough rate is visibly smaller than the observed in the group *a*, arriving close to 0.2 on March 7th, the best day, but remaining bellow it in all the recorded days.


## Question 2
### Which results do people tend to try first? How does it change day-to-day?

### Clean Data

Here we are interested in *visitPage* events that happened after a search. The *visitPage* events are recorded in the *num_clicks* variable and the *position* of the result clicked first in the SERP (search engine result page) is recorded in *first_click* variable.

```{r clean_2}
sessions <- searches %>%
  mutate(day = round_date(first_event_date_time, unit="day")) %>% 
  filter(num_clicks >= 1)
```


```{r question_2}

searches %>% 
  mutate(day = day(session_start_date)) %>% 
  group_by(first_click) %>% 
  ggplot(aes(x = day, y = first_click, fill=day)) +
  geom_bar(stat="identity", position="dodge")

```


